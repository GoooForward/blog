---
title: STM32学习笔记2——系统架构
date: 2024-10-10 23:29:00
updated: 2024-10-15 22:13:07
hide: false
tags: stm32
categories: 学习
---

# 0x00 Reference

[AHB与APB总线介绍_ahb apb-CSDN博客](https://blog.csdn.net/m0_60503814/article/details/139231790)

[深入理解MPU_mpu为什么不能直接访问寄存器-CSDN博客](https://blog.csdn.net/qq_20334947/article/details/86603530)

# 0x01 Cortex-M3内核架构

stm32是基于cm3内核的mcu，所以先看cm3的内核架构是怎么样的（每个色块表示一个组件）

![image-20241014222237921](https://cdn.jsdelivr.net/gh/GoooForward/picture@main/note-image/image-20241014222237921.png)

> CM3采用的是哈弗架构，所以取指和数据使用的总线是分开的

* **嵌套向量中断控制器NVIC(Nested Vectored Interrupt Controller)**：NVIC 是一个在 CM3 中内建的中断控制器，在中断发生时，它会自动取出对应的服务例程入口地址，并且直接调用，无需软件判定中断源

* **系统时钟定时器SYSTICK**：Systick是一个基本定时器，是24位向下计数器，归零时会产生中断并且自动重新装载。它是个比较单纯的时基定时器，它的功能相对其他外设TIMER，功能就较为单一，不支持输入捕获、比较输出等复杂功能，也不能触发DMA等。但是它的中断号是15，优先级比其他通用定时器高

* **存储器保护单元MPU**：MPU 是一个选配的单元，有些 CM3 芯片可能没有配备此组件。它可以将存储器分为不同的区域，并且设定不同的访问权限，提高系统运行的健壮性。例如避免应用任务破坏其他任务或者OS内核使用的栈或数据存储器。

* **总线矩阵BusMatrix**：BusMatrix 是 CM3 内部总线系统的核心。它是一个 AHB 互连的网络，通过它可以让数据在不同的总线之间并行传送——只要两个总线主机不试图访问同一块内存区域

    > [AHB与APB总线介绍_ahb apb-CSDN博客](https://blog.csdn.net/m0_60503814/article/details/139231790)

* **总线桥AHB-to-APB Bridge**：总线桥，顾名思义就是连接两种不同总线之间的桥梁，在APB总线中，Bridge是唯一的主机，也就是APB总线所有的数据请求都是由总线桥发出的。它用于把若干个 APB 设备连接到 CM3 处理器的私有外设总线上（包括内部的和外部的APB设备）

框图中其它的组件都用于调试，通常不会在应用程序中使用它们。



# 0x02 STM32 系统架构

STM32内部系统架构如下图

<img src="https://cdn.jsdelivr.net/gh/GoooForward/picture@main/note-image/image-20241015204725359.png" alt="image-20241015204725359" style="zoom:67%;" />

其主要分为主机部分和从机部分，也叫驱动单元（可以主动发起通信）和被动单元（只能被驱动工作）

* I Code总线：CM3内核的指令总线，连接Flash接口，负责在 0x0000_0000 – 0x1FFF_FFFF 之间的取指操作；I Code是一条32位的总线，也就是一次取指操作可以读取32位的指令，对于16位的Thumb指令来说，CM3内核一次可以取出两条指令

* D Code总线：CM3内核的数据总线，也是一条的 32 位总线，负责在 0x0000_0000 – 0x1FFF_FFFF 之间的数据访问操作，连接闪存存储器数据接口（Flash），用于各种数据访问，如常量、变量等

* System总线：CM3内核的系统总线 ，也是一条32 位总线，负责在 0x2000_0000 – 0xDFFF_FFFF 和 0xE010_0000 – 0xFFFF_FFFF 之间的所有数据传送，包括取值和数据。连接所有外设（如：GPIO、SPI、IIC、TIM等），用于控制各种外设工作，如配置各种外设相关寄存器等

* DMA总线：DMA是直接存储访问，可以在不需要CPU参与的情况下完成数据搬运，可以实现内存到外设、外设到内存、内存到内存的数据传输。STM32F103内部有两个DMA控制器

* 内部FLASH：FLASH是STM32的硬盘，用于存储代码和数据，其内部的数据掉电后也不会丢失。FLASH最高访问速度是24Mhz

* 内部 SRAM：SRAM是STM32的内存，用于临时数据存储，直接挂载在总线矩阵上面，SRAM的最高访问速度是72MHz，比Flash要快

    > there is a question?
    >
    > D-code bus的寻址范围是0x0000_0000 – 0x1FFF_FFFF，而SRAM的映射是从0x2000_0000开始的，但是正点原子的教材中说CPU通过D-Code访问SRAM？网上对于这一问题似乎没有明确的答案，因此在StackOverflow上提问了
    >
    > [stm32 - Can STM32F103 access internal SRAM via D-Code Bus? - Stack Overflow](https://stackoverflow.com/questions/79090269/can-stm32f103-access-internal-sram-via-d-code-bus)

* FSMC：FSMC（Flexible Static Memory Controller）即灵活的静态存储控制器，实际上就是一个外部总线接口，可以用来访问外部SRAM、NAND/NOR FLASH、LCD等。它也是直接挂在总线矩阵上面的，以方便CPU快速访问外挂器件

* AHB to APB桥：用于桥接AHB总线和APB总线，其中APB总线有两条，APB2是全速的72MHz，APB1总线是慢速的36MHz，这三条总线上挂载了STM32内部绝大部分外设
* 总线矩阵：总线矩阵协调内核系统总线和DMA主控总线之间的访问仲裁，仲裁利用轮换算法，保证各个总线之间的有序访问，从而确保工作正常。

# 0x03 STM32存储器映射

老规矩先上图

<img src="https://cdn.jsdelivr.net/gh/GoooForward/picture@main/note-image/image-20241015220738841.png" alt="image-20241015220738841" style="zoom: 50%;" />

ST将4GB空间分成8个块，每个块512MB

| 存储块  | 功能               | 地址范围                           |
| ------- | ------------------ | ---------------------------------- |
| Block 0 | Code               | 0X0000 0000 ~ 0x1FFF FFFF（512MB） |
| Block 1 | SRAM               | 0X2000 0000 ~ 0x3FFF FFFF（512MB） |
| Block 2 | 外设               | 0X4000 0000 ~ 0x5FFF FFFF（512MB） |
| Block 3 | FSMC Bank1&2       | 0X6000 0000 ~ 0x7FFF FFFF（512MB） |
| Block 4 | FSMC Bank3&4       | 0X8000 0000 ~ 0x9FFF FFFF（512MB） |
| Block 5 | FSMC 寄存器        | 0XA000 0000 ~ 0xBFFF FFFF（512MB） |
| Block 6 | 没用到             | 0XC000 0000 ~ 0xDFFF FFFF（512MB） |
| Block 7 | Cortex M3 内部外设 | 0XE000 0000 ~ 0xFFFF FFFF（512MB） |